<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Urbbis | Gestor de Senales</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"/>
    <link rel="stylesheet" href="css/global.css">
    <link rel="stylesheet" href="css/sidebar.css">
    <link rel="stylesheet" href="css/map.css">
    <link rel="stylesheet" href="css/dashboard.css">
    <link rel="stylesheet" href="css/chat.css">
</head>
<body>
    <div id="loginOverlay">
        <div class="login-layout">
            <div class="login-hero"></div>
            <div class="login-card">
                <img src="src/assets/logo-login.png" class="login-logo" alt="Logo">
                <h2>Acceso</h2>
                <p>Ingresa tu correo y contraseña para continuar</p>
                <form id="formLogin">
                    <label for="inputCorreo">Correo electrónico</label>
                    <input type="email" id="inputCorreo" placeholder="usuario@correo.com" required>
                    <label for="inputClave">Contraseña</label>
                    <input type="password" id="inputClave" placeholder="********" required>
                    <div class="login-actions">
                        <a href="#" class="login-link">¿Contraseña olvidada?</a>
                        <button type="submit" id="btnLogin">Iniciar sesión</button>
                    </div>
                </form>
                <small class="login-hint">Municipal: distrito@muni.gob.pe / Muni123! | Visitante: visitante@correo.com / Visitante123</small>
            </div>
        </div>
    </div>

    <div id="dashboardOverlay" class="dashboard-overlay hidden" aria-hidden="true">
        <aside class="dash-sidebar">
            <div class="dash-brand">
                <div class="dash-logo">URBBIS</div>
            </div>

            <div class="dash-user">
                <div class="dash-avatar" aria-hidden="true"><span id="dashAvatarInitials">UR</span></div>
                <div class="dash-user-meta">
                    <div class="dash-welcome">Bienvenido,</div>
                    <div class="dash-name" id="dashUserName">Usuario</div>
                    <div class="dash-email" id="dashUserEmail"></div>
                </div>
            </div>

            <nav class="dash-nav" aria-label="Navegacion principal">
                <button type="button" class="dash-link active" data-dash="dashboard">Dashboard</button>
                <button type="button" class="dash-link" data-dash="mapa">Mapa</button>
                <button type="button" class="dash-link" data-dash="inversion">Inversion</button>
                <button type="button" class="dash-link" data-dash="reportes">Reportes</button>
                <button type="button" class="dash-link" data-dash="tareas">Tareas</button>
                <button type="button" class="dash-link" data-dash="apu">APU</button>
                <button type="button" class="dash-link" data-dash="config">Configuracion</button>
            </nav>

            <button type="button" id="btnDashLogout" class="dash-logout">Cerrar sesion</button>
        </aside>

        <main class="dash-main">
            <div class="dash-page" data-dash-page="dashboard">
                <div class="dash-top">
                    <div>
                        <div class="dash-entity" id="dashEntity">Entidad: Municipalidad</div>
                        <div class="dash-msg">Hoy es un gran dia para mejorar la seguridad vial.</div>
                    </div>
                </div>

                <div class="dash-title">
                    <h1>Dashboard <span>/ Resumen General</span></h1>
                </div>

                <section class="dash-grid" aria-label="Resumen general">
                    <article class="dash-card dash-card--primary">
                        <div class="dash-card-head">
                            <div class="dash-card-kicker">Estado general de señalizacion</div>
                            <button type="button" class="dash-card-go" data-dash-go="mapa" title="Ir al mapa">↗</button>
                        </div>
                        <div class="dash-card-value"><span id="dashScore">0</span><span class="dash-card-unit">/100</span></div>
                    </article>

                    <article class="dash-card dash-card--secondary">
                        <div class="dash-card-head">
                            <div class="dash-card-kicker">Señales registradas</div>
                            <button type="button" class="dash-card-go" data-dash-go="reportes" title="Ver reportes">↗</button>
                        </div>
                        <div class="dash-card-value"><span id="dashTotalSenales">0</span></div>
                        <div class="dash-card-sub">Activas en tu proyecto</div>
                    </article>

                    <article class="dash-card dash-card--muted">
                        <div class="dash-card-head">
                            <div class="dash-card-kicker">Inversion en señalizacion</div>
                            <button type="button" class="dash-card-go" data-dash-go="reportes" title="Ver detalle">↗</button>
                        </div>
                        <div class="dash-card-sub">Monto:</div>
                        <div class="dash-card-money" id="dashInversion">S/ 0</div>
                        <div class="dash-card-sub">Valor estimado de infraestructura instalada</div>
                    </article>

                    <article class="dash-card dash-card--muted">
                        <div class="dash-card-head">
                            <div class="dash-card-kicker">Señales requieren atencion</div>
                            <button type="button" class="dash-card-go" data-dash-go="reportes" title="Ver pendientes">↗</button>
                        </div>
                        <div class="dash-card-split">
                            <div class="dash-card-big" id="dashAtencion">0</div>
                            <div>
                                <div class="dash-card-sub"><strong>Señales</strong><br>requieren atencion</div>
                                <div class="dash-card-sub">Deterioradas o no operativas</div>
                            </div>
                        </div>
                    </article>
                </section>
            </div>

            <div class="dash-page hidden" data-dash-page="inversion">
                <div class="dash-top">
                    <div>
                        <div class="dash-entity">Inversion</div>
                        <div class="dash-msg">Resumen de costos y activos por proyecto.</div>
                    </div>
                </div>
                <div class="dash-title">
                    <h1>Inversion <span>/ Resumen</span></h1>
                </div>
                <section class="inv-grid">
                    <article class="inv-card inv-card--total">
                        <div class="inv-card-title">Inversion total</div>
                        <div class="inv-card-value" id="invTotal">S/ 0</div>
                    </article>
                    <article class="inv-card inv-card--ok">
                        <div class="inv-card-title">Activos operativos</div>
                        <div class="inv-card-value" id="invOperativos">S/ 0</div>
                        <div class="inv-card-sub" id="invOperativosPct">0%</div>
                    </article>
                    <article class="inv-card inv-card--warn">
                        <div class="inv-card-title">Activos deteriorados</div>
                        <div class="inv-card-value" id="invDeteriorados">S/ 0</div>
                        <div class="inv-card-sub" id="invDeterioradosPct">0%</div>
                    </article>
                    <article class="inv-card inv-card--danger">
                        <div class="inv-card-title">Inversion reposicion</div>
                        <div class="inv-card-value" id="invReposicion">S/ 0</div>
                    </article>
                </section>

                <section class="inv-block">
                    <h3>Distribucion de inversion por tipo de activo</h3>
                    <div class="inv-bars">
                        <div class="inv-bar">
                            <span>Senales de transito</span>
                            <div class="inv-bar-track"><div id="invBarTransito" class="inv-bar-fill inv-bar-fill--blue"></div></div>
                            <strong id="invValTransito">S/ 0</strong>
                        </div>
                        <div class="inv-bar">
                            <span>Marcas viales</span>
                            <div class="inv-bar-track"><div id="invBarMarcas" class="inv-bar-fill inv-bar-fill--gold"></div></div>
                            <strong id="invValMarcas">S/ 0</strong>
                        </div>
                        <div class="inv-bar">
                            <span>Mobiliario vial</span>
                            <div class="inv-bar-track"><div id="invBarMobiliario" class="inv-bar-fill inv-bar-fill--green"></div></div>
                            <strong id="invValMobiliario">S/ 0</strong>
                        </div>
                    </div>
                </section>

                <section class="inv-block">
                    <h3>Detalle de activos / partidas</h3>
                    <table class="inv-table">
                        <thead>
                            <tr><th>Activo</th><th>Tipo</th><th>Cantidad</th><th>Estado</th><th>Inversion</th></tr>
                        </thead>
                        <tbody id="invTablaBody"></tbody>
                    </table>
                </section>

                <section class="inv-block">
                    <h3>Inversion proyectada</h3>
                    <div class="inv-summary">
                        <div class="inv-summary-row"><span>Activos sin verificacion</span><strong id="invSinVerif">S/ 0</strong></div>
                        <div class="inv-summary-row"><span>Mantenimiento sugerido</span><strong id="invMantenimiento">S/ 0</strong></div>
                        <div class="inv-summary-row"><span>Reposicion critica</span><strong id="invReposicionCrit">S/ 0</strong></div>
                        <div class="inv-summary-row inv-summary-row--total"><span>Inversion total proxima etapa</span><strong id="invTotalProxima">S/ 0</strong></div>
                    </div>
                </section>

                <div class="ai-chat" aria-live="polite">
                    <button id="aiChatToggle" class="ai-chat-toggle" type="button" aria-label="Abrir chat AI" aria-controls="aiChatPanel" aria-expanded="false">AI</button>
                    <div id="aiChatPanel" class="ai-chat-panel hidden" role="dialog" aria-label="Chat de inversion AI" aria-modal="false">
                        <div class="ai-chat-head">
                            <div>
                                <div class="ai-chat-title">Asistente de inversion</div>
                                <div class="ai-chat-sub" id="aiChatStatus">Simulacion desactivada</div>
                            </div>
                            <button id="aiChatClose" class="ai-chat-close" type="button" aria-label="Cerrar chat">&times;</button>
                        </div>
                        <div class="ai-chat-body" id="aiChatBody"></div>
                        <div class="ai-chat-quick" id="aiChatQuick"></div>
                        <form id="aiChatForm" class="ai-chat-form" autocomplete="off">
                            <input id="aiChatInput" type="text" placeholder="Escribe tu consulta..." autocomplete="off">
                            <button type="submit" class="ai-chat-send">Enviar</button>
                        </form>
                        <div class="ai-chat-footer">Soporte: +51 993931475</div>
                    </div>
                </div>
            </div>

            <div class="dash-page hidden" data-dash-page="apu">
                <div class="dash-top">
                    <div>
                        <div class="dash-entity">APU</div>
                        <div class="dash-msg">Analisis de precios unitarios por partida.</div>
                    </div>
                </div>
                <div class="dash-title">
                    <h1>APU <span>/ Analisis de precios unitarios</span></h1>
                </div>
                <section class="apu-panel" aria-label="Analisis de precios unitarios">
                    <div class="apu-controls">
                        <div class="apu-control">
                            <label for="apuCategoria">Partida</label>
                            <select id="apuCategoria">
                                <option value="transito">Senales de transito</option>
                                <option value="marcas">Marcas viales</option>
                                <option value="mobiliario">Mobiliario vial</option>
                            </select>
                        </div>
                        <div class="apu-control">
                            <label for="apuBuscar">Buscar</label>
                            <input id="apuBuscar" type="text" placeholder="Buscar partida...">
                        </div>
                    </div>
                    <div class="apu-meta">
                        <span id="apuCapitulo">Capitulo: -</span>
                        <span id="apuFecha">Fecha: -</span>
                        <span id="apuMoneda">Moneda: -</span>
                        <span id="apuTotal">Items: 0</span>
                    </div>
                    <div class="apu-table-wrap">
                        <table class="apu-table">
                            <thead>
                                <tr><th>Codigo</th><th>Partida</th><th>Unidad</th><th>Costo directo</th><th>Total</th></tr>
                            </thead>
                            <tbody id="apuTablaBody"></tbody>
                        </table>
                    </div>
                    <div class="apu-detail">
                        <div class="apu-detail-head">
                            <h3 id="apuDetalleTitulo">Detalle de partida</h3>
                            <span id="apuDetalleSub">Selecciona una partida para ver insumos.</span>
                        </div>
                        <div id="apuDetalleContenido"></div>
                    </div>
                </section>
            </div>

            <div class="dash-page hidden" data-dash-page="tareas">
                <div class="dash-top">
                    <div>
                        <div class="dash-entity">Tareas</div>
                        <div class="dash-msg">Gestion y seguimiento de eventos.</div>
                    </div>
                </div>
                <div class="dash-title">
                    <h1>Tareas <span>/ Eventos</span></h1>
                </div>
                <div class="reporte-card reporte-avisos dash-avisos-expanded">
                    <h3>Eventos</h3>
                    <div class="reportes-toolbar reportes-toolbar--compact">
                        <input id="filtroAvisoTextoTareas" type="text" placeholder="Buscar aviso...">
                        <select id="filtroAvisoEstadoTareas">
                            <option value="">Todos los estados</option>
                            <option value="pendiente">Pendiente</option>
                            <option value="atendido">Atendido</option>
                        </select>
                        <select id="filtroAvisoOrdenTareas">
                            <option value="antiguos">Mas antiguos primero</option>
                            <option value="recientes">Mas recientes primero</option>
                        </select>
                        <button id="btnLimpiarFiltrosAvisosTareas" type="button" class="btnToolbar">Limpiar</button>
                    </div>
                    <table id="tablaAvisosTareas">
                        <thead>
                            <tr><th>ID</th><th>Region</th><th>Distrito</th><th>Tipo</th><th>Descripcion</th><th>Estado</th><th>Fecha</th><th>Imagen</th></tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <!-- <section class="dash-config" aria-label="Configuracion">
                    <article class="dash-card dash-card--muted dash-config-card">
                        <h3 class="dash-section-title">Cuenta</h3>
                        <div class="dash-form">
                            <label>Nombre</label>
                            <input id="cfgNombre" type="text" placeholder="Tu nombre">
                            <div class="dash-grid-2">
                                <div>
                                    <label>Email</label>
                                    <input id="cfgEmail" type="text" disabled>
                                </div>
                                <div>
                                    <label>Rol</label>
                                    <input id="cfgRol" type="text" disabled>
                                </div>
                            </div>
                            <div class="dash-actions-row">
                                <button id="btnCfgGuardarPerfil" type="button" class="dash-btn">Guardar</button>
                            </div>
                        </div>
                    </article>

                    <article class="dash-card dash-card--muted dash-config-card">
                        <h3 class="dash-section-title">Preferencias</h3>
                        <div class="dash-form">
                            <div class="dash-toggle">
                                <div>
                                    <div class="dash-toggle-title">Tema oscuro</div>
                                    <div class="dash-toggle-sub">Cambia el estilo visual de la interfaz.</div>
                                </div>
                                <label class="switch">
                                    <input id="cfgTemaOscuro" type="checkbox">
                                    <span class="slider"></span>
                                </label>
                            </div>
                            <div class="dash-toggle">
                                <div>
                                    <div class="dash-toggle-title">Animaciones</div>
                                    <div class="dash-toggle-sub">Transiciones suaves en mapa y paneles.</div>
                                </div>
                                <label class="switch">
                                    <input id="cfgAnimaciones" type="checkbox" checked>
                                    <span class="slider"></span>
                                </label>
                            </div>
                            <div class="dash-toggle">
                                <div>
                                    <div class="dash-toggle-title">Notificaciones</div>
                                    <div class="dash-toggle-sub">Avisos del sistema (proximamente).</div>
                                </div>
                                <label class="switch">
                                    <input id="cfgNotificaciones" type="checkbox">
                                    <span class="slider"></span>
                                </label>
                            </div>
                        </div>
                    </article>

                    <article class="dash-card dash-card--muted dash-config-card">
                        <h3 class="dash-section-title">Mapa</h3>
                        <div class="dash-form">
                            <div class="dash-grid-2">
                                <div>
                                    <label>Zoom inicial</label>
                                    <input id="cfgZoomInicial" type="number" min="10" max="19" step="1">
                                </div>
                                <div>
                                    <label>Duracion animacion (s)</label>
                                    <input id="cfgAnimDur" type="number" min="0" max="3" step="0.1">
                                </div>
                            </div>
                            <div class="dash-actions-row">
                                <button id="btnCfgIrALima" type="button" class="dash-btn dash-btn--ghost">Centrar Lima</button>
                            </div>
                        </div>
                    </article>

                    <article class="dash-card dash-card--muted dash-config-card">
                        <h3 class="dash-section-title">Datos</h3>
                        <div class="dash-form">
                            <div class="dash-actions-row">
                                <button id="btnCfgExportar" type="button" class="dash-btn">Exportar JSON</button>
                                <label class="dash-btn dash-btn--ghost dash-file">
                                    Importar JSON
                                    <input id="cfgImportar" type="file" accept="application/json">
                                </label>
                            </div>
                            <div class="dash-help">Incluye senales horizontales, verticales y avisos ciudadanos del navegador.</div>
                        </div>
                    </article>
                </section> -->
                <div class="dash-placeholder">
                    <strong>En construccion</strong>
                    <p>Este modulo te permitira asignar y dar seguimiento a tareas por distrito, tipo de señal y prioridad.</p>
                </div>
            </div>

            <div class="dash-page hidden" data-dash-page="config">
                <div class="dash-top">
                    <div>
                        <div class="dash-entity">Configuracion</div>
                        <div class="dash-msg">Preferencias de cuenta, mapa y datos.</div>
                    </div>
                </div>
                <div class="dash-title">
                    <h1>Configuracion <span>/ Preferencias</span></h1>
                </div>
                <section class="dash-config" aria-label="Configuracion">
                    <article class="dash-card dash-card--muted dash-config-card">
                        <h3 class="dash-section-title">Cuenta</h3>
                        <div class="dash-form">
                            <label>Nombre</label>
                            <input id="cfgNombre" type="text" placeholder="Tu nombre">
                            <div class="dash-grid-2">
                                <div>
                                    <label>Email</label>
                                    <input id="cfgEmail" type="text" disabled>
                                </div>
                                <div>
                                    <label>Rol</label>
                                    <input id="cfgRol" type="text" disabled>
                                </div>
                            </div>
                            <div class="dash-actions-row">
                                <button id="btnCfgGuardarPerfil" type="button" class="dash-btn">Guardar</button>
                            </div>
                        </div>
                    </article>

                    <article class="dash-card dash-card--muted dash-config-card">
                        <h3 class="dash-section-title">Preferencias</h3>
                        <div class="dash-form">
                            <div class="dash-toggle">
                                <div>
                                    <div class="dash-toggle-title">Tema oscuro</div>
                                    <div class="dash-toggle-sub">Cambia el estilo visual de la interfaz.</div>
                                </div>
                                <label class="switch">
                                    <input id="cfgTemaOscuro" type="checkbox">
                                    <span class="slider"></span>
                                </label>
                            </div>
                            <div class="dash-toggle">
                                <div>
                                    <div class="dash-toggle-title">Animaciones</div>
                                    <div class="dash-toggle-sub">Transiciones suaves en mapa y paneles.</div>
                                </div>
                                <label class="switch">
                                    <input id="cfgAnimaciones" type="checkbox" checked>
                                    <span class="slider"></span>
                                </label>
                            </div>
                            <div class="dash-toggle">
                                <div>
                                    <div class="dash-toggle-title">Notificaciones</div>
                                    <div class="dash-toggle-sub">Avisos del sistema (proximamente).</div>
                                </div>
                                <label class="switch">
                                    <input id="cfgNotificaciones" type="checkbox">
                                    <span class="slider"></span>
                                </label>
                            </div>
                        </div>
                    </article>

                    <article class="dash-card dash-card--muted dash-config-card">
                        <h3 class="dash-section-title">Mapa</h3>
                        <div class="dash-form">
                            <div class="dash-grid-2">
                                <div>
                                    <label>Zoom inicial</label>
                                    <input id="cfgZoomInicial" type="number" min="10" max="19" step="1">
                                </div>
                                <div>
                                    <label>Duracion animacion (s)</label>
                                    <input id="cfgAnimDur" type="number" min="0" max="3" step="0.1">
                                </div>
                            </div>
                            <div class="dash-actions-row">
                                <button id="btnCfgIrALima" type="button" class="dash-btn dash-btn--ghost">Centrar Lima</button>
                            </div>
                        </div>
                    </article>

                    <article class="dash-card dash-card--muted dash-config-card">
                        <h3 class="dash-section-title">Datos</h3>
                        <div class="dash-form">
                            <div class="dash-actions-row">
                                <button id="btnCfgExportar" type="button" class="dash-btn">Exportar JSON</button>
                                <label class="dash-btn dash-btn--ghost dash-file">
                                    Importar JSON
                                    <input id="cfgImportar" type="file" accept="application/json">
                                </label>
                            </div>
                            <div class="dash-help">Incluye senales horizontales, verticales y avisos ciudadanos del navegador.</div>
                        </div>
                    </article>
                </section>
                <div class="dash-placeholder">
                    <strong>En construccion</strong>
                    <p>Aqui podras configurar costos por señal, permisos, catálogos de iconos y parametros de reportes.</p>
                </div>
            </div>
        </main>
    </div>

    <div id="mapFloatingControls" class="map-floating-controls" aria-label="Controles del mapa">
        <div class="map-floating-row">
            <div class="filtro-block desktop-search map-floating-search">
                <input type="text" id="inputBuscar" placeholder="Buscar un lugar...">
                <button id="btnBuscarDireccion" class="btnBuscar">Buscar</button>
                <div id="sugerencias" class="sugerencias"></div>
            </div>
        </div>
        <div class="map-floating-row map-floating-project hidden" id="projectSwitcher" aria-label="Proyecto activo">
            <div class="project-chip">
                <span class="project-label">Proyecto activo</span>
                <select id="selectProyecto"></select>
            </div>
            <button id="btnCambiarProyecto" type="button" class="map-floating-btn map-floating-btn--ghost">Cambiar proyecto</button>
            <button id="btnAgregarProyecto" type="button" class="map-floating-btn map-floating-btn--ghost">Agregar proyecto</button>
        </div>
        <div class="map-floating-row map-floating-actions" aria-label="Acciones">
            <button id="btnMapVisualizacion" type="button" class="map-floating-btn">Visualizaci&oacute;n</button>
            <button id="btnMapAgregar" type="button" class="map-floating-btn map-floating-btn--dark"><span class="plus">+</span> Agregar</button>
        </div>
        <div id="visualizacionPanel" class="map-floating-panel hidden" aria-label="Opciones de visualizacion">
            <div class="map-panel-section">
                <label class="map-panel-check">
                    <input id="chkLayerTransito" type="checkbox" checked>
                    <span>Se&ntilde;ales tr&aacute;nsito</span>
                </label>
                <label class="map-panel-check">
                    <input id="chkLayerMarcas" type="checkbox" checked>
                    <span>Marcas viales</span>
                </label>
                <label class="map-panel-check">
                    <input id="chkLayerMobiliario" type="checkbox" checked>
                    <span>Mobiliario vial</span>
                </label>
                <label class="map-panel-check">
                    <input id="chkLayerEventos" type="checkbox" checked>
                    <span>Eventos</span>
                </label>
            </div>
            <button id="btnVisualizacionAvanzada" type="button" class="map-panel-btn">Configuraci&oacute;n avanzada</button>
            <div id="visualizacionAvanzada" class="map-panel-advanced hidden" aria-label="Configuracion avanzada">
                <div class="map-panel-group">
                    <div class="map-panel-title">Estado de conservaci&oacute;n:</div>
                    <label class="map-panel-check"><input id="chkConsOperativos" type="checkbox" checked> <span>Operativos</span></label>
                    <label class="map-panel-check"><input id="chkConsDeteriorados" type="checkbox" checked> <span>Deteriorados</span></label>
                    <label class="map-panel-check"><input id="chkConsNoOperativos" type="checkbox" checked> <span>No operativos</span></label>
                </div>
                <div class="map-panel-group">
                    <div class="map-panel-title">Verificaci&oacute;n de campo:</div>
                    <label class="map-panel-check"><input id="chkFotoCon" type="checkbox" checked> <span>Con fotograf&iacute;a</span></label>
                    <label class="map-panel-check"><input id="chkFotoSin" type="checkbox" checked> <span>Sin fotograf&iacute;a</span></label>
                </div>
                <div class="map-panel-group">
                    <div class="map-panel-title">Filtro de tiempo:</div>
                    <label class="map-panel-check"><input id="chkTiempoActivos" type="checkbox" checked> <span>Activos ahora</span></label>
                    <label class="map-panel-check"><input id="chkTiempoProgramados" type="checkbox" checked> <span>Programados</span></label>
                    <label class="map-panel-check"><input id="chkTiempoSinFinalizados" type="checkbox" checked> <span>Sin finalizados</span></label>
                </div>
                <button id="btnVisualizacionReset" type="button" class="map-panel-btn map-panel-btn--ghost">Restablecer</button>
            </div>
        </div>
        <div id="metradoPanel" class="map-floating-panel hidden" aria-label="Metrado de pintura">
            <div class="map-panel-section metrado-panel">
                <div class="metrado-head">
                    <div class="map-panel-title" style="margin-top:2px">Metrado de pintura</div>
                    <button id="btnMetradoVerRegistros" type="button" class="map-panel-btn map-panel-btn--ghost metrado-btn-inline" title="Ver trazos del proyecto">
                        <svg class="metrado-btn-icon" viewBox="0 0 24 24" aria-hidden="true">
                            <path d="M4 6h16M4 12h16M4 18h10" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <span class="metrado-btn-text">Trazos</span>
                    </button>
                </div>
                <div id="metradoStatus" class="metrado-status">Inicia el trazado y marca puntos sobre la pista.</div>
                <div class="metrado-field">
                    <div class="map-panel-title">Nombre del trazado</div>
                    <input id="metradoNombre" type="text" class="metrado-input" placeholder="Ej: Av. Lima - tramo 1">
                </div>
                <div class="metrado-actions metrado-actions--compact">
                    <button id="btnMetradoInicio" type="button" class="map-panel-btn map-panel-btn--ghost metrado-action-btn">
                        <svg class="metrado-action-icon" viewBox="0 0 24 24" aria-hidden="true">
                            <path d="M8 5l10 7-10 7z" fill="currentColor"/>
                        </svg>
                        <span class="metrado-action-text">Iniciar</span>
                    </button>
                    <button id="btnMetradoFin" type="button" class="map-panel-btn map-panel-btn--ghost metrado-action-btn" disabled>
                        <svg class="metrado-action-icon" viewBox="0 0 24 24" aria-hidden="true">
                            <rect x="6" y="6" width="12" height="12" rx="2" fill="currentColor"/>
                        </svg>
                        <span class="metrado-action-text">Finalizar</span>
                    </button>
                </div>
                <div class="metrado-actions metrado-actions--secondary metrado-actions--compact">
                    <button id="btnMetradoUndo" type="button" class="map-panel-btn map-panel-btn--ghost metrado-action-btn" disabled>
                        <svg class="metrado-action-icon" viewBox="0 0 24 24" aria-hidden="true" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M9 7L5 11l4 4"/>
                            <path d="M5 11h9a4 4 0 1 1 0 8h-1"/>
                        </svg>
                        <span class="metrado-action-text">Deshacer</span>
                    </button>
                    <button id="btnMetradoLimpiar" type="button" class="map-panel-btn map-panel-btn--ghost metrado-action-btn">
                        <svg class="metrado-action-icon" viewBox="0 0 24 24" aria-hidden="true" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
                            <path d="M7 7l10 10M17 7l-10 10"/>
                        </svg>
                        <span class="metrado-action-text">Limpiar</span>
                    </button>
                </div>
                <details id="metradoOptionsDetails" class="metrado-options-details">
                    <summary class="metrado-options-summary" aria-controls="metradoOptions" title="Opciones">
                        <span class="metrado-options-label">Opciones</span>
                        <span class="metrado-options-chev" aria-hidden="true">&rsaquo;</span>
                    </summary>
                    <div id="metradoOptions" class="metrado-options">
                    <div class="metrado-field">
                        <div class="map-panel-title">Ajuste a vias</div>
                        <label class="map-panel-check">
                            <input id="metradoSnapVias" type="checkbox" checked>
                            <span>Seguir vias cercanas (beta)</span>
                        </label>
                    </div>
                    <div class="metrado-field">
                        <div class="map-panel-title">Ancho de l&iacute;nea</div>
                        <div class="metrado-check-row" id="metradoAncho">
                            <label class="map-panel-check"><input type="radio" name="metradoAncho" value="0.10" checked> <span>10 cm</span></label>
                            <label class="map-panel-check"><input type="radio" name="metradoAncho" value="0.15"> <span>15 cm</span></label>
                        </div>
                    </div>
                    <div class="metrado-field">
                        <div class="map-panel-title">Tipo de v&iacute;a</div>
                        <div class="metrado-check-col" id="metradoTipoVia">
                            <label class="map-panel-check"><input type="radio" name="metradoVia" value="urbana" checked> <span>Calle urbana</span></label>
                            <label class="map-panel-check"><input type="radio" name="metradoVia" value="autopista"> <span>Autopista</span></label>
                            <label class="map-panel-check"><input type="radio" name="metradoVia" value="carretera"> <span>Carretera</span></label>
                        </div>
                    </div>
                    <div id="metradoUrbanExtra" class="metrado-urban-extra">
                        <div class="metrado-field">
                            <div class="map-panel-title">&iquest;Tiene separador central f&iacute;sico?</div>
                            <div class="metrado-check-row" id="metradoSeparador">
                                <label class="map-panel-check"><input type="radio" name="metradoSep" value="si" checked> <span>S&iacute;</span></label>
                                <label class="map-panel-check"><input type="radio" name="metradoSep" value="no"> <span>No</span></label>
                            </div>
                            <div class="metrado-help">S&iacute; en avenidas, No en calles locales.</div>
                        </div>
                        <div class="metrado-field">
                            <div class="map-panel-title">Sentido de la v&iacute;a</div>
                            <div class="metrado-check-row" id="metradoSentido">
                                <label class="map-panel-check"><input type="radio" name="metradoSentido" value="unico" checked> <span>Un solo sentido</span></label>
                                <label class="map-panel-check"><input type="radio" name="metradoSentido" value="doble"> <span>Doble sentido</span></label>
                            </div>
                        </div>
                    </div>
                    </div>
                </details>
                <div class="metrado-results" aria-label="Resultados">
                    <div class="metrado-kpi">
                        <span>Longitud</span>
                        <strong id="metradoDistancia">-</strong>
                    </div>
                    <div class="metrado-kpi">
                        <span>Total l&iacute;neas</span>
                        <strong id="metradoMetrado">-</strong>
                    </div>
                </div>
                <details class="metrado-options-details metrado-breakdown-details">
                    <summary class="metrado-options-summary" aria-controls="metradoBreakdown" title="Detalle de l&iacute;neas">
                        <span class="metrado-options-label">Detalle de l&iacute;neas</span>
                        <span class="metrado-options-chev" aria-hidden="true">&rsaquo;</span>
                    </summary>
                    <div id="metradoBreakdown" class="metrado-breakdown" aria-label="Detalle de l&iacute;neas">
                        <div class="metrado-line metrado-line--yellow">
                            <span>Eje central (amarillo)</span>
                            <strong id="metradoEje">-</strong>
                        </div>
                        <div class="metrado-line metrado-line--white">
                            <span>L&iacute;neas laterales (blancas)</span>
                            <strong id="metradoLaterales">-</strong>
                        </div>
                        <div class="metrado-line metrado-line--white">
                            <span>L&iacute;neas internas (blancas)</span>
                            <strong id="metradoInternas">-</strong>
                        </div>
                        <div class="metrado-line metrado-line--area">
                            <span>&Aacute;rea estimada (m&sup2;)</span>
                            <strong id="metradoArea">-</strong>
                        </div>
                    </div>
                </details>
                <button id="btnMetradoInspeccion" type="button" class="map-panel-btn map-panel-btn--ghost" disabled>Subir inspecci&oacute;n</button>
                <button id="btnMetradoRegistrar" type="button" class="map-panel-btn" disabled>Registrar</button>
            </div>
        </div>
    </div>

    <div id="registroHint" class="registro-hint hidden" aria-hidden="true">Haz click en el mapa para colocar la ubicaci&oacute;n.</div>

    <div id="registroPicker" class="registro-picker hidden" aria-hidden="true">
        <div class="registro-picker-card" role="dialog" aria-modal="true" aria-label="Seleccion de registro">
            <div class="registro-picker-header">
                <button type="button" id="btnRegistroBack" class="registro-picker-back hidden" aria-label="Volver">Volver</button>
                <div class="registro-picker-title" id="registroPickerTitle">&iquest;Qu&eacute; deseas registrar?</div>
            </div>

            <div class="registro-picker-grid" id="registroPickerGridMain" role="list">
                <button type="button" class="registro-picker-option" data-registro-tipo="transito" role="listitem">
                    <span class="registro-opt-icon registro-opt-icon--transito" aria-hidden="true"></span>
                    <span class="registro-opt-text">Se&ntilde;ales<br>de tr&aacute;nsito</span>
                </button>
                <button type="button" class="registro-picker-option" data-registro-tipo="marcas" role="listitem">
                    <span class="registro-opt-icon registro-opt-icon--marcas" aria-hidden="true"></span>
                    <span class="registro-opt-text">Marcas<br>viales</span>
                </button>
                <button type="button" class="registro-picker-option" data-registro-tipo="mobiliario" role="listitem">
                    <span class="registro-opt-icon registro-opt-icon--mobiliario" aria-hidden="true"></span>
                    <span class="registro-opt-text">Mobiliario<br>vial</span>
                </button>
                <button type="button" class="registro-picker-option" data-registro-tipo="eventos" role="listitem">
                    <span class="registro-opt-icon registro-opt-icon--eventos" aria-hidden="true"></span>
                    <span class="registro-opt-text">Eventos</span>
                </button>
            </div>

            <div class="registro-picker-grid registro-picker-grid--sub hidden" id="registroPickerGridMarcas" role="list" aria-label="Opciones de marcas viales">
                <button type="button" class="registro-picker-option" data-registro-marcas="pintado" role="listitem">
                    <span class="registro-opt-icon registro-opt-icon--pintado" aria-hidden="true"></span>
                    <span class="registro-opt-text">Lineas y<br>guionadas</span>
                </button>
                <button type="button" class="registro-picker-option" data-registro-marcas="senalizacion" role="listitem">
                    <span class="registro-opt-icon registro-opt-icon--senalizacion" aria-hidden="true"></span>
                    <span class="registro-opt-text">Simbologia<br>vial</span>
                </button>
            </div>

            <button type="button" id="btnRegistroCancelar" class="registro-picker-cancel">Cancelar</button>
        </div>
    </div>

    <aside id="registroPanel" class="registro-panel hidden" aria-hidden="true" aria-label="Panel de registro"></aside>

    <div id="mobileSearch" class="mobile-search">
        <input type="text" id="inputBuscarMobile" placeholder="Buscar direccion...">
        <button id="btnBuscarDireccionMobile" class="btnBuscar">Buscar</button>
        <div id="sugerenciasMobile" class="sugerencias"></div>
    </div>

    <aside id="sidebar">
        <div class="sidebar-top">
            <button id="btnMenu" class="icon-btn">≡</button>
        </div>

        <div class="sidebar-content">
            <h2>Filtros</h2>
            <div class="filtro-block">
                <h3>Region y distrito</h3>
                <select id="selectRegion"></select>
                <select id="selectDistrito"></select>
            </div>

            <button id="btnAplicarFiltros">Aplicar seleccion</button>

            <div class="filtro-block">
                <h3>Estado</h3>
                <div class="estado-buttons">
                    <button class="btnFiltro" data-estado="nueva">Operativa</button>
                    <button class="btnFiltro" data-estado="antigua">Deteriorada</button>
                    <button class="btnFiltro" data-estado="sin_senal">No operativa</button>
                    <button id="btnMostrarTodas" class="btnGhost fullwidth">Limpiar filtros</button>
                </div>
            </div>

            <hr>
            <button id="btnUbicacion" class="btnUbicacion">Mi ubicacion</button>
            <button id="btnReportar" class="btnGhost fullwidth">Reportar problema</button>
        </div>
    </aside>
        <button id="btnFloatingFilters" class="floating-fab search" title="Filtros y busqueda"></button>
    <button id="btnFloatingReport" class="floating-fab report" title="Reportes">!</button>
    <button id="btnFloatingLogout" class="floating-fab logout" title="Cerrar sesion"></button>

    <div id="map">
        <div class="legend">
            <div class="legend-title">Estados</div>
            <div class="legend-item"><span class="dot dot-new"></span> Operativa</div>
            <div class="legend-item"><span class="dot dot-bad"></span> Deteriorada</div>
            <div class="legend-item"><span class="dot dot-missing"></span> No operativa</div>
        </div>
    </div>

    <section id="reportes" class="hidden">
        <div class="reportes-sheet">
            <div class="sheet-handle"></div>
            <button id="btnCerrarReportes" class="close-reportes">Cerrar</button>
            <div class="reporte-card reporte-horizontal">
                <h3>Reporte Marcas Viales</h3>
                <table id="tablaHorizontal">
                    <thead>
                        <tr><th>ID</th><th>Tipo</th><th>Nombre</th><th>Estado</th><th>Fecha</th></tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <div class="reporte-card reporte-vertical">
                <h3>Reporte Se&ntilde;ales de Tr&aacute;nsito</h3>
                <table id="tablaVertical">
                    <thead>
                        <tr><th>ID</th><th>Tipo</th><th>Nombre</th><th>Estado</th><th>Fecha</th></tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <div class="reporte-card reporte-avisos">
                <h3>Eventos</h3>
                <div class="reportes-toolbar">
                    <input id="filtroAvisoTexto" type="text" placeholder="Buscar aviso...">
                    <select id="filtroAvisoTipo">
                        <option value="">Todos los tipos</option>
                        <option value="falta">Falta señal</option>
                        <option value="danada">Señal dañada</option>
                        <option value="obstruida">Obstruida</option>
                        <option value="otro">Otro</option>
                    </select>
                    <select id="filtroAvisoEstado">
                        <option value="">Todos los estados</option>
                        <option value="pendiente">Pendiente</option>
                        <option value="atendido">Atendido</option>
                    </select>
                    <div class="toolbar-dates">
                        <input id="filtroAvisoDesde" type="date" title="Desde">
                        <input id="filtroAvisoHasta" type="date" title="Hasta">
                    </div>
                    <select id="filtroAvisoOrden">
                        <option value="antiguos">Más antiguos primero</option>
                        <option value="recientes">Más recientes primero</option>
                    </select>
                    <button id="btnLimpiarFiltrosAvisos" type="button" class="btnToolbar">Limpiar</button>
                </div>
                <table id="tablaAvisos">
                    <thead>
                        <tr><th>ID</th><th>Region</th><th>Distrito</th><th>Tipo</th><th>Descripcion</th><th>Estado</th><th>Fecha</th><th>Imagen</th></tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <div class="reporte-card reporte-historial">
                <h3>Historial de cambios</h3>
                <table id="tablaHistorial">
                    <thead>
                        <tr><th>Fecha</th><th>Accion</th><th>ID</th><th>Tipo</th><th>Distrito</th><th>Detalle</th></tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </section>

    <div id="modalReporte" class="modal hidden">
        <div class="modal-content">
            <h3>Reportar problema</h3>
            <label>Tipo de problema</label>
            <select id="inputTipoProblema">
                <option value="falta">Falta señal</option>
                <option value="danada">Señal dañada</option>
                <option value="obstruida">Obstruida</option>
                <option value="otro">Otro</option>
            </select>
            <label>Nombre</label>
            <input type="text" id="inputNombreReporte" placeholder="Nombre y apellido">
            <label>DNI</label>
            <input type="text" id="inputDniReporte" inputmode="numeric" maxlength="8" placeholder="00000000">
            <label>Descripcion</label>
            <textarea id="inputDescripcion" rows="3" placeholder="Describe el problema"></textarea>
            <label>Foto (opcional)</label>
            <input type="file" id="inputFoto" accept="image/*">
            <div class="ubica">
                <span id="infoUbicacion">Haz click en el mapa para fijar la ubicacion.</span>
                <button id="btnElegirMapa" class="btnGhost fullwidth" type="button">Elegir en mapa</button>
            </div>
            <div class="modal-actions">
                <button id="btnCancelarReporte" class="btnGhost">Cancelar</button>
                <button id="btnEnviarReporte">Enviar aviso</button>
            </div>
        </div>
    </div>

    <div id="modalProyecto" class="modal hidden" aria-hidden="true">
        <div class="modal-content project-modal">
            <div class="project-modal-head">
                <h3>Agregar proyecto</h3>
                <button id="btnProyectoClose" type="button" class="inspeccion-close">&times;</button>
            </div>
            <div class="project-form">
                <label for="inputProyectoNombre">Nombre del proyecto</label>
                <input id="inputProyectoNombre" type="text" placeholder="Ej: Registro senalizacion 2026">
                <div class="project-grid">
                    <div>
                        <label for="inputProyectoInicio">Fecha inicio</label>
                        <input id="inputProyectoInicio" type="date">
                    </div>
                    <div>
                        <label for="inputProyectoFin">Fecha fin</label>
                        <input id="inputProyectoFin" type="date">
                    </div>
                </div>
                <div class="project-checks">
                    <label class="map-panel-check"><input id="chkProyectoTransito" type="checkbox" checked> <span>Senales de transito</span></label>
                    <label class="map-panel-check"><input id="chkProyectoMarcas" type="checkbox" checked> <span>Marcas viales</span></label>
                    <label class="map-panel-check"><input id="chkProyectoMobiliario" type="checkbox" checked> <span>Mobiliario vial</span></label>
                </div>
                <div class="project-hint">Selecciona las senales en el mapa con click izquierdo.</div>
            </div>
            <div class="project-preview">
                <div class="project-preview-title">Proyecto: <span id="projectPreviewName">-</span></div>
                <div class="project-preview-meta">
                    <span id="projectPreviewDates">Sin fechas</span>
                    <span id="projectPreviewCount">0 activos</span>
                </div>
                <div class="project-table-wrap">
                    <table id="tablaProyectoPreview" class="project-table">
                        <thead>
                            <tr><th>Tipo</th><th>Nombre</th><th>Estado</th><th>Verificado</th><th>Ubicacion</th><th>Quitar</th></tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            <div class="modal-actions">
                <button id="btnProyectoCancelar" type="button" class="map-panel-btn map-panel-btn--ghost">Cancelar</button>
                <button id="btnProyectoGuardar" type="button" class="map-panel-btn">Guardar</button>
            </div>
        </div>
    </div>

    <div id="modalInspeccion" class="modal hidden" aria-hidden="true">
        <div class="modal-content inspeccion-modal">
            <div class="inspeccion-head">
                <h3>Registro de inspecci&oacute;n</h3>
                <button id="btnInspeccionClose" type="button" class="inspeccion-close">&times;</button>
            </div>
            <label for="insDistancia">Distancia de medici&oacute;n (m)</label>
            <input id="insDistancia" type="number" min="0" step="1" value="100">
            <label for="insUbicacion">Ubicaci&oacute;n / progresiva</label>
            <input id="insUbicacion" type="text" placeholder="Ej: Km 18 a Km 22">
            <label for="insComprende">Comprende</label>
            <input id="insComprende" type="text" placeholder="Ej: Av. Mariano Condorcanqui...">
            <label>Retroreflectividad</label>
            <div class="inspeccion-grid">
                <div class="inspeccion-row">
                    <span>Lateral izquierda</span>
                    <input id="insLi" type="number" min="0" step="1" placeholder="0">
                    <label class="inspeccion-file">
                        <input id="insLiFoto" type="file" accept="image/*">
                        <span>Foto</span>
                    </label>
                </div>
                <div class="inspeccion-row">
                    <span>Lateral derecha</span>
                    <input id="insLd" type="number" min="0" step="1" placeholder="0">
                    <label class="inspeccion-file">
                        <input id="insLdFoto" type="file" accept="image/*">
                        <span>Foto</span>
                    </label>
                </div>
                <div class="inspeccion-row">
                    <span>Eje central 1</span>
                    <input id="insEc1" type="number" min="0" step="1" placeholder="0">
                    <label class="inspeccion-file">
                        <input id="insEc1Foto" type="file" accept="image/*">
                        <span>Foto</span>
                    </label>
                </div>
                <div class="inspeccion-row">
                    <span>Eje central 2</span>
                    <input id="insEc2" type="number" min="0" step="1" placeholder="0">
                    <label class="inspeccion-file">
                        <input id="insEc2Foto" type="file" accept="image/*">
                        <span>Foto</span>
                    </label>
                </div>
            </div>
            <div class="modal-actions inspeccion-actions">
                <button id="btnInspeccionAgregar" type="button" class="map-panel-btn map-panel-btn--ghost">Agregar</button>
                <button id="btnInspeccionFinalizar" type="button" class="map-panel-btn">Finalizar</button>
            </div>
            <div id="inspeccionPrev" class="inspeccion-prev hidden">
                <div class="inspeccion-prev-title">Medici&oacute;n anterior</div>
                <div id="inspeccionPrevBody" class="inspeccion-prev-body"></div>
                <button id="btnInspeccionVerTodo" type="button" class="map-panel-btn map-panel-btn--ghost">Ver registro completo</button>
            </div>
        </div>
    </div>

    <div id="modalInspeccionListado" class="modal hidden" aria-hidden="true">
        <div class="modal-content inspeccion-modal inspeccion-modal--list">
            <div class="inspeccion-head">
                <h3>Registro completo</h3>
                <button id="btnInspeccionListClose" type="button" class="inspeccion-close">&times;</button>
            </div>
            <div id="inspeccionList" class="inspeccion-list"></div>
        </div>
    </div>

    <div id="modalMetradoRegistros" class="modal hidden" aria-hidden="true">
        <div class="modal-content inspeccion-modal inspeccion-modal--list">
            <div class="inspeccion-head">
                <h3>Trazos registrados</h3>
                <button id="btnMetradoRegistrosClose" type="button" class="inspeccion-close">&times;</button>
            </div>
            <div id="metradoRegistrosList" class="inspeccion-list"></div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
    <script src="js/data.js"></script>
    <script src="js/map.js"></script>
    <script src="js/ui.js"></script>
    <script src="js/filters.js"></script>
    <script src="js/events.js"></script>
    <script src="js/reportes.js"></script>
    <script src="js/chat.js"></script>
</body>
</html>
